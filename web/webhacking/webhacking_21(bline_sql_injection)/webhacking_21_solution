21번 문제는 제목부터 blind sql injection이다!!

여태까지 풀었던 문제처럼 search를 하는 것이 아니라 id,pw를 입력하게끔 로그인 페이지가 구현되어있다.

혹시 힌트가 있을까 하는 마음에 소스코드를 보았지만 힌트는 없었다.
아마 예상하건데 admin의 계정으로 로그인하는 것이 이번 문제의 목표가 아닐까 추측해본다.

id를 admin으로 하고 pw를 아무값이나 넣었을때 결과는 login fail 이라고 나온다.

혹시나 하는 마음에 id admin, pw 1'or'1'='1 을 넣어보았으나 실패다..ㅠㅠ
근데 여기서 긍정적인 것은 login fail이 아닌 wrong password라고 뜨면서 다른 값이 나온다.

즉 출력값이 두 가지인 경우를 찾아냈음으로 이것을 이용하여 blind sql injection을 시도해볼수
있겠다.

id는 admin으로 고정하고 pw만 쿼리를 바꿔가면서 풀어볼 것이다.

if((length(database()))in({i}),1'or'1'='1,1234)

if(1,1'or'1'='1,1234) ==> 테스트용

위와 같이 쿼리를 짜고 1'or'1'='1 값이 제대로 들어가는지 테스트용 쿼리를 짜서 넣어보았으나
이유는 모르겠는데 테스트용 쿼리에서 wrong password라고 안뜨고 login fail이라고 뜬다;;;

select * from [table_name] where id=${id} and pw=${pw}

여기서 생각해볼 수 있는 것은 wrong password라고 뜨는 것은 sql 쿼리에 들어가기 전에 특정
문자열이 삽입시 필터링되어 뜨는 문구라고 생각해 볼 수 있을 것 같다. 
위의 쿼리를 서버쪽 sql쿼리라고 가정할 때 id부분에 admin'#을 써서 우회해보려했으나
wrong password라고 뜬 것을 보아 블랙리스트로 특정 공격 쿼리 문자열을 필터링하는 구조인 것 같다. (아마도 정규표현식을 사용해서 필터링 하는 듯??)

이렇게 가정하고 풀다보니 정말 노답이다....흠 다시 처음부터 생각해보자

id/pw를 각각 admin / 1'or'1'='1 으로 값을 집어넣으면 wrong password 라고 뜬다.
여기서 문득 든 생각은 혹시 pw부분에 인젝션 쿼리를 false값이 되게 넣으면 결과가 어떻게 될까?
admin / 1'or'1'='0 으로 집어 넣어봤더니 login fail이라고 뜬다.

이것을 통해 알 수 있는 사실은 정규표현식으로 블랙리스트로 인젝션 쿼리를 걸러내는것은 맞지만 그것이
참값일 경우에만 걸러낸다는 사실을 알아낼 수 있다.

즉, 인젝션 쿼리가 참인 경우와 거짓인 경우 두 가지의 케이스를 이용하여 blind sql injection을 시도해 볼 수 있겠다.

if문을 이용하여 blind sql injection을 시도하려고 하면 위와 같이 추측한 이유로 아마 안되는 것같으니 다른 방법을 이용하여 sql인젝션을 시도해보아야겠다.

admin / 1'or(length(pw)>0)

위와 같은 쿼리를 집어넣으면 결과는 참인 쿼리임으로 wrong password가 떠야된다. 한번 해보겠다.

login fail..... 뭐지??? 왜 안되나 오랜 고민끝에 알 수있는 사실은 pw는 문자열 구문으로
sql에 들어가면 양쪽에 ''이 붙고 따라서 '1'or(length(pw)>0)' 와 같은 이상한 쿼리가 완성된다.
따라서 참이 안됐던거 같다.

그렇다면 주석을 포함시켜
admin / 1'or(length(pw)>0)#

위와같은 쿼리를 집어넣어 보겠다.
wrong password!!! 드디어 원하는 결과가 나왔다ㅠㅠㅠ (하다가 알아낸 사실은 url창에 직접적으로 집어넣으면 wrong password가 안뜬다. 이유는 아마도 url인코딩이 제대로 이루어지지 않고 특수문자들이 일반 문자로??? 취급되서 그런것 같다..)

위와 같은 테스트 쿼리가 성공적으로 테스트 되었으니 위와같은 쿼리형식으로 admin의 pw길이부터 구해보겠다.

admin / 1'or(length(pw)={i})#

(url창에 직접 집어넣으면 문제가 생기는 것 때문에 혹시 몰라서 python 코드를 짜고나서 테스트 쿼리로 테스트 해보았는데... 같은 방식의 문제가 발생하는지 login fail이 뜬다. python 코드에 집어넣을때도 url인코딩을 하여 값을 집어넣어야 할 것 같다. url인코딩한 값을 집어넣으니 정상적으로 wrong password가 뜬다!! 앞으로 get방식으로 인젝션을 할 때는 url인코딩하여 사용하는게 좋을 것 같다.)

따라서 위와 같은 코드를 console창에 escape()함수를 이용하여 이스케이프 한 후 python 코드를 짜서 값을 구해보았다. (webhacking_21-1.py)

값을 구해보니 pw의 길이는 5자리로 나온다. 이제 pw의 값을 구해보겠다.

admin / 1'or(ascii(substr(pw,{i},1)))={j}#

pw값이 ghere이 나왔다. 한번 로그인 시도해보겠다.

login fail이 뜬다.....허허;;;;

왜 로그인 fail이 뜰까 곰곰히 생각해보았다.

select * from [table_name] where id='admin' and pw='1'or(length(pw)={i})#

내가 넣은 값을 토대로면 위와 같은 쿼리가 sql에 삽입될 것이다.
위 코드를 자세히 보면 where 부분에서 and 다음 or이 쓰이는데 연산자 우선순위에 의하면
and가 먼저고 그 다음 or이다 따라서 id='admin' and pw='1' 는 false 
그리고 false or (length(pw)={i})#의 형태가 된다.

여기서 중요한 것은 pw의 길이를 구한 값이 우리가 생각하던 admin의 pw길이가 아니라 다른 id의
길이일수도 있다는 것이다.

만약 pw 속성의 값이 여러값이 있다면 그중 다른 id값의 pw가 5자리라면 그것과 비교하여 참인 값
즉, wrong password를 출력했을수도 있다는 의미다.(9번 문제때를 보면 id값을 비교할때 id값이 여러개면 그 여러개의 값을 전부다 비교한다는 것을 알 수 있었다!!)

위의 사실을 테스트 해보기 위해 python 코드를 최대길이가 20일떄에서 40일때로 바꿔서 한번 length값을 구해보겠다.

그 결과 놀랍게도 위에 사실과 맞게 length값이 5,36 두 개가 출력되었다 ㄷㄷ

그렇다면 pw의 값을 구할때도 마찬가지로 두개의 pw값을 모두 비교하여 ghere이라는 값이 구해졌을 것이며 이것은 아마도 첫번째 pw값과 두번째 pw값의 각 자리마다 ascii 순서가 먼저인게 한자리씩 출력되면서 섞여서 값이 출력됬다고 볼수있겠다.

따라서 pw값 출력과정 코드를 수정해야 될 것 같다.

admin / 1'or(id='admin')and(ascii(substr(pw,{i},1)))={j}#
(webhacking_21-1.py)

위와 같이 코드를 수정한 이유는 쿼리 결과가 or 이후 값이 참이 되어 wrong password라는 값이 반환되는데 and 구문으로 pw의 값을 구하는 구문 뿐만 아니라 id='admin'을 같이 넣어줌으로써 admin의 pw를 대상으로만 값이 구해지게끔 쿼리를 짠것이다.

결과는 클리어!!

(5자리로 구했을때 ghere가 나왔었는데 여기서 앞 5자리는 there가 나왔다!!
즉, 위에서 가정한 사실이 정확히 맞으며 위에서는 두 개의 pw값을 가지고 값을 비교해 출력했음을 알 수 있다!!)


